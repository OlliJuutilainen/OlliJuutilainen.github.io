<!doctype html>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex">
<title>TUSINASÄÄ·12</title>
<style>
  :root { color-scheme: dark; }
  html,body{height:100%}
  body{
    margin:0; padding:28px 14px 24px; background:#000; color:#e8e8e8;
    font:17px/1.5 Arial,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility
  }
  .mini{ color:#5d676f; font-size:12px; letter-spacing:.3px }
  .caps{ text-transform:uppercase; letter-spacing:.5px }
  .list{ border-top:1px solid #2a2a2a; margin-top:6px; }

  /* Grid: [time | temp | desc | rain | wind] */
  .hdr{
    color:#5d676f; font-size:12px; letter-spacing:.3px; margin:6px 0 4px 0;
    display:grid; grid-template-columns:54px 64px 1fr 70px 64px; align-items:end;

    /* UUSI: keskitä oletuksena kaikki otsakesolut täsmäkeskelle */
    justify-items: center;
  }
  /* UUSI: kolme ensimmäistä otsakesolua vasempaan laitaan kuten ennen */
  .hdr div:nth-child(-n+3){
    justify-self: start;
    text-align: left;
  }
  /* (entinen säätö saa jäädä — ei haittaa) */
  .hdr div:nth-child(4), .hdr div:nth-child(5){ text-align:center } /* SADE, TUULI */

  .row{
    display:grid; grid-template-columns:54px 64px 1fr 70px 64px;
    gap:8px; padding:6px 0; border-bottom:1px solid #1c1c1c; align-items:center;
  }
  .row > div:first-child{ border-right:1px solid #2a2a2a; padding-right:10px; margin-right:4px; }

  .muted{ color:#515a62 } .soft{ color:#515a62 }
  .t{ text-align:left } .t.hh{ text-align:right }

  .desc .ditto{ display:inline } .ditto{ color:inherit } /* pelkkä » */

  /* 0-sade ajatusviiva keskelle — mutta otetaan lisäksi KOKO sade-sarake keskelle */
  .dash{ text-align:center }
  /* UUSI (valinnainen, mutta nyt mukana): keskitetään kaiken sisällön sade-sarakkeessa */
  .row > div:nth-child(4){ text-align:center; }

  .err{ color:#ff6b6b; white-space:pre-wrap }
</style>

<!-- Otsakerivi: (tyhjä) | ( ) | ( ) | SADE | TUULI -->
<div class="hdr">
  <div></div><div></div><div></div>
  <div class="caps">SADE</div>
  <div class="caps">TUULI</div>
</div>
<div class="list" id="out" aria-live="polite"></div>

<script>
/* Lähteet:
   - Sade t0–t2: MET Nowcast 2.0 (/complete). Muut tunnit: FMI HARMONIE (precipitation1h).
   - Lämpötila: aina FMI HARMONIE (temperature).
   - Tuuli: aina FMI HARMONIE (windspeedms).
     • Puuska: t0–t2 Nowcast (wind_speed_of_gust); jos ei ole, ei puuskaa.
     • t3→ ei puuskaa tässä kyselyssä.
   - Kuvaus: FMI HARMONIE SmartSymbol.
   Debug: ?dbg=1 näyttää lähdetageja (NC / HRM).
*/

const q = new URLSearchParams(location.search);
const LAT = parseFloat(q.get('lat'));
const LON = parseFloat(q.get('lon'));
const TZ  = 'Europe/Helsinki';
const out = document.getElementById('out');
const DBG = q.has('dbg');
function tag(s){ return DBG ? ` <span class="soft" style="font-size:12px">${s}</span>` : ''; }

/* Aikaformatit */
const hmFi = new Intl.DateTimeFormat('fi-FI',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:TZ,hourCycle:'h23'});
function fmtHM(d){ const ps=hmFi.formatToParts(d); return `${ps.find(p=>p.type==='hour')?.value||'00'}:${ps.find(p=>p.type==='minute')?.value||'00'}`; }
function fmtH(d){ const ps=hmFi.formatToParts(d); return `${ps.find(p=>p.type==='hour')?.value||'00'}`; }

/* SmartSymbol – täysi sanasto + sinun uudelleennimet */
const SS_TEXT = {
  // Taivas / näkyväisyys
  1: 'Sinistä',
  2: 'Sangen sinistä',
  4: 'Siniharmaata',
  6: 'Sangen harmaata',
  7: 'Harmaata',
  9: 'MIST!',

  // Ukkoskuurot
  71: 'Ukkoa kutittaa',
  74: 'Ukkoa ärsyttää',
  77: 'Ukko on vihainen',

  // Sadekuurot (vesi)
  21: 'Kuurot 1',
  24: 'Kuurot 2',
  27: 'Kuurot 3',

  // Tihku / jäätävä sade
  11: 'Tihkua',
  14: 'Kryotihkua',
  17: 'Kryosadetta',

  // Jatkuva vesisade
  31: 'Siniharmaasta ripsii',
  34: 'Sangen harmaasta ripsii',
  37: 'Ripsii',

  32: 'Siniharmaasta satelee',
  35: 'Sangen harmaasta satelee',
  38: 'Satelee',

  33: 'Siniharmaasta kaatosadettakin',
  36: 'Sangen harmaasta myös kaatosadettakin',
  39: 'Kaatosadetta',

  // Räntä
  41: 'Siniharmaasta märkä hiutale',
  44: 'Sangen harmaasta märkä hiutale',
  47: 'Märkä hiutale',

  42: 'Siniharmaasta räntää',
  45: 'Sangen harmaasta räntää',
  48: 'Räntää',

  43: 'Siniharmaasta tiskirättiä',
  46: 'Sangen harmaasta tiskirättiä',
  49: 'Tiskirättiä',

  // Lumi
  51: 'Sinihirmaasta kevyt hiutale',
  54: 'Sangen harmaasta kevyt hiutale',
  57: 'Kevyt hiutale',

  52: 'Siniharmaasta lunta',
  55: 'Sangen harmaasta lunta',
  58: 'Lunta',

  53: 'Siniharmaasta pyryä',
  56: 'Sangen harmaasta pyryä',
  59: 'Pyryttää.',

  // Rakeet
  61: 'Raekuurot 1',
  64: 'Raekuurot 2',
  67: 'Raekuurot 3'
};
/* Palauta teksti; yöarvot normalisoidaan 100:lla (101→1, jne.) */
const ssText = c => { if (c == null) return ''; const key = Number(c) % 100; return SS_TEXT[key] || ''; };

/* FMI WFS */
function buildWfsForecast(lat,lon){
  const base='https://opendata.fmi.fi/wfs?service=WFS&version=2.0.0&request=getFeature';
  const sq='fmi::forecast::harmonie::surface::point::timevaluepair';
  const params='temperature,precipitation1h,windspeedms,SmartSymbol';
  const now=new Date(), s=new Date(now), e=new Date(now);
  s.setHours(s.getHours()-2); e.setHours(e.getHours()+24);
  const iso=d=>d.toISOString().replace(/\.\d{3}Z$/,'Z');
  return `${base}&storedquery_id=${encodeURIComponent(sq)}&latlon=${encodeURIComponent(lat+','+lon)}&parameters=${encodeURIComponent(params)}&starttime=${encodeURIComponent(iso(s))}&endtime=${encodeURIComponent(iso(e))}&timestep=60`;
}

/* XML → sarjat */
const parseXML = txt => {
  const x = new DOMParser().parseFromString(txt,'application/xml');
  const ex = x.querySelector('Exception, ows\\:Exception');
  if (ex){ const t=x.querySelector('ExceptionText, ows\\:ExceptionText'); throw new Error('FMI virhe: '+(t?t.textContent:'Tuntematon virhe')); }
  return x;
};
const extractSeries = x => {
  const get=(e,n)=>e.getElementsByTagNameNS('*',n)[0];
  const all=x.getElementsByTagNameNS('http://www.opengis.net/waterml/2.0','MeasurementTimeseries');
  const o={};
  for (const s of all){
    const id=(s.getAttribute('gml:id')||'').toLowerCase();
    let k='';
    if (id.includes('temperature')) k='temperature';
    else if (id.includes('precipitation1h')) k='precipitation1h';
    else if (id.includes('windspeedms')) k='windspeedms';
    else if (id.includes('smartsymbol')) k='SmartSymbol';
    if (!k) continue;
    const map=new Map();
    const pts=s.getElementsByTagNameNS('http://www.opengis.net/waterml/2.0','MeasurementTVP');
    for (const p of pts){
      const t=get(p,'time')?.textContent;
      const v=get(p,'value')?.textContent;
      if (!t) continue;
      const num = v!=null ? Number(v) : null;
      map.set(t, isNaN(num)?null:num);
    }
    o[k]=map;
  }
  return o;
};

/* MET Nowcast 2.0 complete – sade ja (t0–t2) tuulen puuska */
async function fetchNowcastForHour(lat, lon, dUTC){
  try{
    const url = `https://api.met.no/weatherapi/nowcast/2.0/complete?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&altitude=0`;
    const res = await fetch(url, { cache:'no-store', headers: { 'Accept': 'application/json' } });
    if (!res.ok) return { val:null, meta:`NC!${res.status}` };
    const js = await res.json();
    const ts = js?.properties?.timeseries;
    if (!Array.isArray(ts) || !ts.length) return { val:null, meta:'NC!empty' };

    const targetUTC = dUTC.getTime();
    let best = ts.find(it => new Date(it.time).getTime() === targetUTC);
    if (!best){
      const fut = ts.map(it=>({t:new Date(it.time).getTime(), it})).filter(x=>x.t>=targetUTC).sort((a,b)=>a.t-b.t)[0];
      if (fut && (fut.t - targetUTC) <= 30*60*1000) best = fut.it;
    }
    if (!best){
      let cand=null, diff=1e12;
      for (const it of ts){ const dt=Math.abs(new Date(it.time).getTime()-targetUTC); if (dt<diff){diff=dt; cand=it;} }
      if (cand && diff <= 20*60*1000) best = cand;
    }
    if (!best) return { val:null, meta:'NC!miss' };

    const acc  = best?.data?.next_1_hours?.details?.precipitation_amount;
    const pr   = best?.data?.instant?.details?.precipitation_rate;
    const gust = best?.data?.instant?.details?.wind_speed_of_gust;

    let p = null;
    if (typeof acc === 'number') p = acc;
    else if (typeof pr === 'number') p = pr;

    return { val:(typeof p==='number'?p:null), meta:'NC', gust:(typeof gust==='number'?gust:null) };
  }catch{ return { val:null, meta:'NC!err' }; }
}

/* Solumuotoilut */
function rainCell(val, {markGrey=false}={}){
  if (val==null || isNaN(Number(val))) return { text:'–', cls:'soft', num:null };
  const n = Number(val);
  if (n === 0) return { text:'—', cls:'soft dash', num:0 };   // 0 aina harmaa keskitetty
  return { text:n.toFixed(1)+' mm', cls:(markGrey?'soft':''), num:n }; // >0 → valkoinen (ellei erikseen harmaa)
}
function windCell(mean, gust, {baseGrey=true}={}){
  const mOk = (mean!=null && !isNaN(Number(mean)));
  const gOk = (gust!=null && !isNaN(Number(gust)));

  const meanV = mOk ? Number(mean) : null;
  const gustV = gOk ? Number(gust) : null;

  let txt = (mOk ? meanV.toFixed(1)+' m/s' : '–');

  // puuska suluissa vain numerona; jos ≥15 m/s → numero valkoisena spanissa
  let gustTxt = '';
  let gustWhite = false;
  if (gOk && gustV >= 15){
    gustTxt = ` (<span style="color:#e8e8e8">${gustV.toFixed(1)}</span>)`;
    gustWhite = true;
  }

  // keskituuli ≥12 → valkoinen
  const meanWhite = (mOk && meanV >= 12);

  // perusluokka harmaa, mutta jos jompikumpi ehto täyttyy → valkoinen
  const cls = (meanWhite || gustWhite) ? '' : (baseGrey ? 'soft' : '');

  return { text: txt + gustTxt, cls };
}

/* Taulukon teko */
(async function(){
  scrollTo(0,1); setTimeout(()=>scrollTo(0,1),150);
  if (!LAT || !LON || isNaN(LAT) || isNaN(LON)){
    out.innerHTML = `<div class="err">Puuttuvat tai virheelliset koordinaatit. Käytä osoitetta:<br><code>?lat=60.1699&lon=24.9384</code></div>`;
    return;
  }

  try{
    const fRes = await fetch(buildWfsForecast(LAT,LON), {cache:'no-store'});
    const fTxt = await fRes.text();
    if (!fRes.ok){ out.innerHTML = `<div class="err">FMI ennuste HTTP ${fRes.status}\n${fTxt.slice(0,400)}</div>`; return; }

    const forecast = extractSeries(parseXML(fTxt));

    const now = new Date();
    const thisHourLocal  = new Date(new Date(now).setMinutes(0,0,0));

    // Nouki 13 tasatuntia alkaen tästä tasatunnista
    const fKeys = Array.from(forecast.temperature?.keys?.()||[]).sort();
    const pickKeys = [];
    for (const k of fKeys){
      const d = new Date(k);
      if (d >= thisHourLocal){ pickKeys.push(k); if (pickKeys.length>=13) break; }
    }
    if (!pickKeys.length){ out.innerHTML = `<div class="muted">Ei rivejä tälle ikkunalle.</div>`; return; }

    // Nowcast t0–t2 (sade + puuska)
    const d0 = new Date(pickKeys[0]);
    const d1 = pickKeys[1] ? new Date(pickKeys[1]) : null;
    const d2 = pickKeys[2] ? new Date(pickKeys[2]) : null;
    const [nc0, nc1, nc2] = await Promise.all([
      fetchNowcastForHour(LAT, LON, d0),
      d1 ? fetchNowcastForHour(LAT, LON, d1) : Promise.resolve({val:null, meta:'NC!skip'}),
      d2 ? fetchNowcastForHour(LAT, LON, d2) : Promise.resolve({val:null, meta:'NC!skip'})
    ]);

    let html = '';
    let prevDesc = null;

    /* t0 (nyt) – kellonaika valkoiseksi vain jos sade > 0 */
    {
      const key = pickKeys[0];
      const temp = forecast.temperature?.get(key);
      const wind = forecast.windspeedms?.get(key);
      const ss   = forecast.SmartSymbol?.get(key);

      // Sade: Nowcast
      const rainVal0 = (nc0 && typeof nc0.val==='number') ? nc0.val : null;
      const rObj = rainCell(rainVal0);
      const rainHtml = `${rObj.text}${tag('NC')}`;
      const timeClass = (rObj.num!=null && rObj.num > 0) ? 't' : 't soft';

      // Tuuli: HARMONIE + puuska NC:stä
      const wObj = windCell(wind, (nc0 && typeof nc0.gust==='number' ? nc0.gust : null), { baseGrey:true });

      const desc = ssText(ss) || '–';

      html += `<div class="row">
        <div class="${timeClass}">${fmtHM(now)}</div>
        <div class="soft">${temp!=null?Math.round(temp)+'°C':'–'}</div>
        <div class="desc soft">${desc}</div>
        <div class="${rObj.cls||''}">${rainHtml}</div>
        <div class="${wObj.cls||''}">${wObj.text}</div>
      </div>`;
      prevDesc = desc;
    }

    /* t+1h */
    if (pickKeys.length >= 2){
      const key = pickKeys[1];
      const dUtc = new Date(key);
      const temp = forecast.temperature?.get(key);
      const wind = forecast.windspeedms?.get(key);
      const rain = forecast.precipitation1h?.get(key);
      const ss   = forecast.SmartSymbol?.get(key);

      let rObj, rTag='NC', rainUsed = null;
      if (nc1 && typeof nc1.val==='number'){ rObj = rainCell(nc1.val); rainUsed = nc1.val; }
      else { rObj = rainCell(rain, {markGrey:true}); rainUsed = (typeof rain==='number'?rain:null); rTag='HRM'; }

      const timeClass = (rainUsed!=null && rainUsed > 0) ? 't' : 't soft';

      const wObj = windCell(wind, (nc1 && typeof nc1.gust==='number' ? nc1.gust : null), { baseGrey:true });

      const desc = ssText(ss) || '–';
      const shownDesc = (desc === prevDesc && desc !== '–')
        ? '<span class="ditto" aria-label="sama kuin edellä" title="sama kuin edellä">&raquo;</span>'
        : desc;

      html += `<div class="row">
        <div class="${timeClass}">${fmtHM(dUtc)}</div>
        <div class="soft">${temp!=null?Math.round(temp)+'°C':'–'}</div>
        <div class="desc soft">${shownDesc}</div>
        <div class="${rObj.cls||''}">${rObj.text}${tag(rTag)}</div>
        <div class="${wObj.cls||''}">${wObj.text}</div>
      </div>`;
      prevDesc = desc;
    }

    /* t+2h */
    if (pickKeys.length >= 3){
      const key = pickKeys[2];
      const dUtc = new Date(key);
      const temp = forecast.temperature?.get(key);
      const wind = forecast.windspeedms?.get(key);
      const rain = forecast.precipitation1h?.get(key);
      const ss   = forecast.SmartSymbol?.get(key);

      let rObj, rTag='NC', rainUsed = null;
      if (nc2 && typeof nc2.val==='number'){ rObj = rainCell(nc2.val); rainUsed = nc2.val; }
      else { rObj = rainCell(rain, {markGrey:true}); rainUsed = (typeof rain==='number'?rain:null); rTag='HRM'; }

      const timeClass = (rainUsed!=null && rainUsed > 0) ? 't' : 't soft';

      const wObj = windCell(wind, (nc2 && typeof nc2.gust==='number' ? nc2.gust : null), { baseGrey:true });

      const desc = ssText(ss) || '–';
      const shownDesc = (desc === prevDesc && desc !== '–')
        ? '<span class="ditto" aria-label="sama kuin edellä" title="sama kuin edellä">&raquo;</span>'
        : desc;

      html += `<div class="row">
        <div class="${timeClass}">${fmtHM(dUtc)}</div>
        <div class="soft">${temp!=null?Math.round(temp)+'°C':'–'}</div>
        <div class="desc soft">${shownDesc}</div>
        <div class="${rObj.cls||''}">${rObj.text}${tag(rTag)}</div>
        <div class="${wObj.cls||''}">${wObj.text}</div>
      </div>`;
      prevDesc = desc;
    }

    /* t+3…t+12 – kellonaika valkoiseksi vain jos HRM-sade > 0 */
    for (let i=3; i<pickKeys.length; i++){
      const key = pickKeys[i];
      const dUtc = new Date(key);
      const temp = forecast.temperature?.get(key);
      const rain = forecast.precipitation1h?.get(key);
      const wind = forecast.windspeedms?.get(key);
      const ss   = forecast.SmartSymbol?.get(key);

      const rObj = rainCell(rain);
      const timeWhite = (rObj.num!=null && rObj.num > 0);

      const desc = ssText(ss) || '–';
      const shownDesc = (desc === prevDesc && desc !== '–')
        ? '<span class="ditto" aria-label="sama kuin edellä" title="sama kuin edellä">&raquo;</span>'
        : desc;
      prevDesc = desc;

      const wObj = windCell(wind, null, { baseGrey:true });

      html += `<div class="row">
        <div class="t hh ${timeWhite?'':'soft'}"><span class="mini">klo&nbsp;</span>${fmtH(dUtc)}</div>
        <div class="soft">${temp!=null?Math.round(temp)+'°C':'–'}</div>
        <div class="desc soft">${shownDesc}</div>
        <div class="${rObj.cls||''}">${rObj.text}${tag('HRM')}</div>
        <div class="${wObj.cls||''}">${wObj.text}</div>
      </div>`;
    }

    out.innerHTML = html || `<div class="muted">Ei rivejä tälle ikkunalle.</div>`;
  }catch(e){
    out.innerHTML = `<div class="err">${String(e.message||e)}</div>`;
  }
})();
</script>
