<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tusinasää – KV-generaattori (MINI)</title>
<style>
  :root { --w: min(820px, 100%); }
  html,body{margin:0;padding:0;font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:#0b0b0c;color:#e7e7ea;}
  main{max-width:var(--w);margin:0 auto;padding:16px;display:grid;gap:10px;}
  h1{font-size:18px;margin:4px 0 8px 0;color:#cfcfd4;}
  label{display:flex;align-items:center;gap:8px;font-weight:600;margin-top:6px}
  input,textarea,button{border-radius:10px;border:1px solid #2a2a2e;background:#141416;color:#e7e7ea;}
  input{padding:10px 12px;width:100%;}
  textarea{padding:10px 12px;width:100%;min-height:110px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px}
  .btn{padding:10px 12px;font-weight:600;border:1px solid #3a3a40;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .ghost{background:#101012}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  #out{min-height:260px}
  small{opacity:.7}
</style>
<main>
  <h1>Tusinasää – KV-generaattori (MINI)</h1>

  <div class="row">
    <label for="key">KEY</label>
    <button class="btn ghost" id="randomKey" title="Generate KEY">Random KEY</button>
  </div>
  <input id="key" autocomplete="off" placeholder="32-merkkinen base64url (24B)">

  <label for="val">VALUE (JSON)</label>
  <textarea id="val" placeholder='{"v":1,"iv":"...","ct":"..."}'></textarea>

  <div class="row">
    <label for="k">K-param</label>
    <button class="btn ghost" id="randomK" title="Generate K">Random K</button>
  </div>
  <input id="k" autocomplete="off" placeholder="43-merkkinen base64url (32B)">

  <div class="actions">
    <button class="btn" id="gen">Generate</button>
    <button class="btn ghost" id="copy">Copy</button>
  </div>

  <textarea id="out" readonly spellcheck="false"></textarea>
  <small>Ei tallenna mitään. Kaikki tapahtuu selaimessasi.</small>
</main>

<script>
  // --- helpers ---
  const $ = sel => document.querySelector(sel);
  const b64url = bytes => btoa(String.fromCharCode(...bytes))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const randB64 = n => { const a = new Uint8Array(n); crypto.getRandomValues(a); return b64url(a); };
  const minifyJson = s => { try { return JSON.stringify(JSON.parse(s)); } catch { return s.trim().replace(/\s+/g,' '); } };
  const prettyJson = s => { try { return JSON.stringify(JSON.parse(s), null, 2); } catch { return s; } };

  function buildOutput() {
    let KEY = $('#key').value.trim();
    if (!KEY) KEY = randB64(24); // 24B -> 32 chars base64url
    $('#key').value = KEY;

    let raw = $('#val').value.trim();
    let VAL_ONE = minifyJson(raw);
    if (!VAL_ONE || VAL_ONE === '') {
      const iv = randB64(12);   // 12B -> 16 chars (matches prior examples)
      const ct = randB64(64);   // demo ciphertext
      VAL_ONE = JSON.stringify({ v:1, iv, ct });
      $('#val').value = prettyJson(VAL_ONE);
    } else {
      $('#val').value = prettyJson(VAL_ONE);
    }

    let K = $('#k').value.trim();
    if (!K) K = randB64(32); // 32B -> 43 chars base64url
    $('#k').value = K;

    const block = [
      `KEY='${KEY}'`,
      `VAL='${VAL_ONE}'`,
      `K='${K}'`,
      ``,
      `# A (binding)`,
      `npx -y wrangler@latest kv key put --remote --binding=LOCATIONS "$KEY" "$VAL"`,
      `npx -y wrangler@latest kv key get --remote --binding=LOCATIONS "$KEY" --text`,
      ``,
      `# B (namespace)`,
      `NS='{{NAMESPACE_ID}}'`,
      `npx -y wrangler@latest kv key put --remote --namespace-id "$NS" "$KEY" "$VAL"`,
      `npx -y wrangler@latest kv key get --remote --namespace-id "$NS" "$KEY" --text`,
      ``,
      `# Web: https://ollijuutilainen.github.io/tusinapaja.html#t=$KEY&k=$K`,
      `# Android: tusinasaa://open/v1#t=$KEY&k=$K`
    ].join("\n");

    $('#out').value = block;
  }

  // --- events ---
  $('#randomKey').addEventListener('click', () => { $('#key').value = randB64(24); });
  $('#randomK').addEventListener('click', () => { $('#k').value = randB64(32); });
  $('#gen').addEventListener('click', buildOutput);
  $('#copy').addEventListener('click', async () => {
    const t = $('#out'); t.focus(); t.select(); t.setSelectionRange(0, t.value.length);
    try { await navigator.clipboard.writeText(t.value); } catch {}
  });

  // initial render
  window.addEventListener('load', buildOutput);
</script>
