<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tusinasää – token+avain generaattori</title>
<style>
  body{
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    margin:24px auto;
    max-width:720px;
    padding:0 16px 48px;
    background:#f5f5f7;
    color:#1c1c1f;
  }
  h1{ font-size:24px; margin-bottom:12px; }
  label{ display:block; margin:12px 0 4px; font-weight:600; }
  input[type="number"], input[type="text"]{
    width:100%; max-width:360px; font-size:16px; padding:8px 10px;
    border:1px solid #b6bcc8; border-radius:6px; box-sizing:border-box;
  }
  button{
    margin-top:18px; padding:10px 20px; font-size:16px; font-weight:600;
    border:none; border-radius:999px; background:#2f4ad0; color:white;
    cursor:pointer;
  }
  button:disabled{ opacity:0.6; cursor:progress; }
  pre{
    background:#111; color:#e8e8e8; padding:18px; border-radius:10px;
    overflow:auto; margin-top:24px; white-space:pre-wrap;
  }
  .note{ font-size:14px; color:#444; margin-top:6px; }
  .err{ color:#b00020; font-weight:600; margin-top:12px; }
</style>
</head>
<body>
<h1>Tusinasää – token+avain generaattori</h1>
<p class="note">Työkalu arpoo tokenin ja salausavaimen, salaa koordinaatit AES-GCM:llä ja tulostaa Cloudflare KV -talletteen sekä valmiit web- ja Android-linkit.</p>

<label for="lat">Leveysaste (lat)</label>
<input id="lat" type="number" step="any" placeholder="60.1699" required>

<label for="lon">Pituusaste (lon)</label>
<input id="lon" type="number" step="any" placeholder="24.9384" required>

<label for="z">Zoom / karttatarkkuus (z)</label>
<input id="z" type="number" value="13" min="1" max="18">

<label for="title">Erikoisotsikko (valinnainen)</label>
<input id="title" type="text" placeholder="TUSINASÄÄ 12 · ">

<label for="baseUrl">Base URL (lukittu)</label>
<input id="baseUrl" type="text" value="https://ollijuutilainen.github.io/tusinapaja.html" readonly>
<p class="note">Base URL on kiinteä, jotta generaattorin tuloste vastaa “pahvi”-spesia. Kenttä säilyy DOM:ssa yhteensopivuuden vuoksi.</p>

<button id="generate">Generoi token &amp; linkit</button>
<div id="error" class="err" role="alert" style="display:none"></div>
<pre id="output" aria-live="polite">Anna sijainti ja paina "Generoi".</pre>

<script type="module">
// Cloudflare KV: LOCATIONS namespace (pysyvä ID)
const NS = '033276b4df18419a8eb60a7d42a4efef';

const latInput = document.getElementById('lat');
const lonInput = document.getElementById('lon');
const zInput = document.getElementById('z');
const titleInput = document.getElementById('title');
const baseInput = document.getElementById('baseUrl');
const generateBtn = document.getElementById('generate');
const output = document.getElementById('output');
const errorBox = document.getElementById('error');

(() => {
  const label = [...document.querySelectorAll('label')]
    .find(l => /Erikoisotsikko/i.test(l.textContent));
  if (!label) return;
  const el = label.control || label.querySelector('input,textarea') ||
             document.getElementById(label.getAttribute('for'));
  if (!el) return;
  el.placeholder = 'TUSINASÄÄ 12 · ';
  if (!el.value) el.value = 'TUSINASÄÄ 12 · ';
})();

const encoder = new TextEncoder();
const TOKEN_LENGTH = 32;
const TOKEN_BYTES = 24; // 24 satunnaistavua -> 32 Base64URL-merkkiä ilman paddingia

function _ts_minifyJson(src) { const o = JSON.parse(src); return JSON.stringify(o); }

function escapeForSingleQuotes(value) {
  return `'${String(value).replace(/'/g, "'\\''")}'`;
}

function sanitizeLabel(value) {
  return (value || 'Tusinasää sijainti').replace(/[\r\n]+/g, ' ').trim();
}

function buildKvBash(label, key, val, k) {
  const safeLabel = sanitizeLabel(label);
  const safeKey = escapeForSingleQuotes(key);
  const safeVal = escapeForSingleQuotes(val);
  const safeK = escapeForSingleQuotes(k);
  return [
`# ${safeLabel} — one-paste, Big Sur OK (remote KV)`,
`NS='${NS}'`,
`KEY=${safeKey}`,
`VAL=${safeVal}`,
`K=${safeK}`,
``,
`npx -y wrangler@latest kv key put --remote --namespace-id "${'$'}NS" "${'$'}KEY" "${'$'}VAL" \\\n&& npx -y wrangler@latest kv key get --remote --namespace-id "${'$'}NS" "${'$'}KEY" --text \\\n&& printf '%s\n%s\n' \\\n"Web: https://ollijuutilainen.github.io/tusinapaja.html#t=${'$'}KEY&k=${'$'}K" \\\n"Android: tusinasaa://open/v1#t=${'$'}KEY&k=${'$'}K"`
  ].join('\n');
}

function clearError(){
  errorBox.style.display = 'none';
  errorBox.textContent = '';
}

function showError(msg){
  errorBox.textContent = msg;
  errorBox.style.display = '';
}

function randomBytes(length){
  const buf = new Uint8Array(length);
  crypto.getRandomValues(buf);
  return buf;
}

function toBase64Url(bytes){
  let binary = '';
  bytes.forEach(b => { binary += String.fromCharCode(b); });
  return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
}

function randomToken(){
  const token = toBase64Url(randomBytes(TOKEN_BYTES));
  if (token.length !== TOKEN_LENGTH){
    throw new Error('Tokenin generointi epäonnistui. Yritä uudelleen.');
  }
  return token;
}

async function encryptLocation(keyBytes, payload){
  const iv = randomBytes(12);
  const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, { name: 'AES-GCM' }, false, ['encrypt']);
  const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, cryptoKey, encoder.encode(payload));
  return { iv: toBase64Url(iv), ct: toBase64Url(new Uint8Array(ciphertext)) };
}

generateBtn.addEventListener('click', async () => {
  clearError();
  generateBtn.disabled = true;
  output.textContent = 'Generoidaan…';

  try {
    const lat = parseFloat(latInput.value);
    const lon = parseFloat(lonInput.value);
    const zoom = zInput.value === '' ? null : parseInt(zInput.value, 10);

    if (!Number.isFinite(lat) || !Number.isFinite(lon)){
      throw new Error('Anna kelvolliset koordinaatit.');
    }

    const payloadObject = { lat, lon };
    const titleRaw = titleInput.value.trim();
    if (titleRaw){
      payloadObject.title = titleRaw.slice(0, 160);
    }
    if (Number.isInteger(zoom)) payloadObject.z = zoom;

    const payloadJson = JSON.stringify(payloadObject);
    const token = randomToken();
    const keyBytes = randomBytes(32); // 256-bit AES-avain
    const keyB64u = toBase64Url(keyBytes);
    const encrypted = await encryptLocation(keyBytes, payloadJson);

    const kvPayload = { v: 1, iv: encrypted.iv, ct: encrypted.ct };
    const kvValue = JSON.stringify(kvPayload, null, 2);
    const baseUrl = 'https://ollijuutilainen.github.io/tusinapaja.html';
    if (baseInput.value !== baseUrl) {
      baseInput.value = baseUrl;
    }
    const rawVal = kvValue;
    let VAL_ONE;
    try {
      VAL_ONE = _ts_minifyJson(rawVal);
    } catch (jsonErr) {
      showError('VAL must be one-line JSON.');
      output.textContent = 'Anna sijainti ja paina "Generoi".';
      throw jsonErr;
    }

    if (/\r|\n/.test(VAL_ONE)) {
      showError('VAL must be one-line JSON.');
      output.textContent = 'Anna sijainti ja paina "Generoi".';
      return;
    }

    if (!token || !VAL_ONE || !keyB64u) {
      showError('Täytearvot puuttuvat. Yritä uudelleen.');
      output.textContent = 'Anna sijainti ja paina "Generoi".';
      return;
    }

    const bash = buildKvBash(payloadObject.title || '', token, VAL_ONE, keyB64u);

    clearError();
    const code = document.createElement('code');
    code.textContent = bash;
    output.replaceChildren(code);
  } catch (err) {
    console.error(err);
    if (err instanceof SyntaxError) {
      showError('VAL must be one-line JSON.');
    } else {
      showError(err?.message || 'Tuntematon virhe.');
    }
    if (!output.querySelector('code')) {
      output.textContent = 'Anna sijainti ja paina "Generoi".';
    }
  } finally {
    generateBtn.disabled = false;
  }
});
</script>
</body>
</html>
