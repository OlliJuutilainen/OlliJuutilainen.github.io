<!doctype html>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex">
<title>SÄÄ SEURAAVAT 12 TUNTIA (FMI)</title>
<style>
  :root { color-scheme: dark; }
  html,body{height:100%}
  body{
    margin:0; padding:28px 14px 24px; background:#000; color:#e8e8e8;
    font:17px/1.5 Arial,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility
  }

  /* yläreunan harmaa viiva + lista */
  .list{
    border-top:1px solid #2a2a2a;
    margin-top:6px;
  }

  /* pieni harmaa "klo" ankkuri kellosarakkeen ylle */
  .klohdr{
    color:#9aa; font-size:12px; letter-spacing:.3px;
    margin:6px 0 4px 0;
    display:grid;
    grid-template-columns:54px 64px 1fr 70px 64px; /* sama rytmi kuin riveillä */
  }
  .klohdr > div:first-child{
    border-right:1px solid #2a2a2a;
    padding-right:10px; margin-right:4px;
  }
  .klohdr > div:not(:first-child){ visibility:hidden; } /* muut otsakkeet piiloon */

  /* rivit */
  .row{
    display:grid; grid-template-columns:54px 64px 1fr 70px 64px;
    gap:8px; padding:6px 0; border-bottom:1px solid #1c1c1c;
  }
  /* pystyviiva kellosarakkeen jälkeen */
  .row > div:first-child{
    border-right:1px solid #2a2a2a;
    padding-right:10px; margin-right:4px;
  }

  .muted{ color:#95a0aa }
  .err{ color:#ff6b6b; white-space:pre-wrap }
</style>

<!-- "klo" ankkuri -->
<div class="klohdr"><div>klo</div><div></div><div></div><div></div><div></div></div>

<!-- lista + rivit -->
<div class="list" id="out" aria-live="polite"></div>

<script>
/* FMI super-min — SmartSymbol ensisijainen (yö normalisoidaan), WS3 varmistus, sade-fallback
   Aika: viimeisin mennyt tasatunti → seuraava klo 11:00 (paikallista aikaa)
   HH:MM, peräkkäisten kuvausten dedup, tumma, pystyviiva + "klo", yläviiva
   Koordinaatit vain URL:sta (?lat=...&lon=...)
*/
const q = new URLSearchParams(location.search);
const LAT = q.get('lat');
const LON = q.get('lon');
const TZ  = 'Europe/Helsinki';

const out = document.getElementById('out');

/* Aika: pakota aina HH:MM (kaksoispiste) */
const tFmt = new Intl.DateTimeFormat('fi-FI', {
  hour:'2-digit', minute:'2-digit', hour12:false, timeZone:TZ, hourCycle:'h23'
});
function fmtHM(d){
  const parts = tFmt.formatToParts(d);
  const hh = parts.find(p=>p.type==='hour')?.value ?? '00';
  const mm = parts.find(p=>p.type==='minute')?.value ?? '00';
  return `${hh}:${mm}`;
}

/* SmartSymbol → tiivis FI-teksti.
   Huom: yö (101..199) normalisoidaan day = code % 100, ei näytetä "yö"-päätteitä. */
function symSmart(code){
  if (code == null) return '';
  const day = Number(code) % 100; // 101..199 → 1..99
  const m = {
    // pouta/pilvisyys
    1:'selkeää',
    2:'lähes selkeää',
    3:'puolipilvistä',
    4:'pilvistä',

    // tihku
    51:'heikkoa tihkua',
    52:'tihkua',
    53:'voimakasta tihkua',

    // sade (jatkuva)
    61:'heikkoa sadetta',
    62:'sadetta',
    63:'rankkasadetta',

    // lumi
    71:'heikkoa lunta',
    72:'lumisadetta',
    73:'runsasta lunta',

    // räntä
    68:'räntää',
    69:'voimakasta räntää',

    // kuurot
    41:'heikkoja kuuroja',
    42:'kuuroja',
    43:'voimakkaita kuuroja',

    // ukkonen
    80:'ukkosta',
    95:'ukkoskuuroja',
    96:'ukkosta ja rakeita',
    97:'voimakasta ukkosta'
  };
  return m[day] || '';
}

/* Weathersymbol3 → tiivis FI-teksti (fallback SS:n jälkeen) */
function symWS3(code){
  const m = {
    1:'selkeää',
    2:'puolipilvistä',
    3:'pilvistä',
    21:'sumua',
    22:'utua',
    41:'heikkoja kuuroja',
    42:'kuuroja',
    43:'voimakkaita kuuroja',
    51:'heikkoa tihkua',
    52:'tihkua',
    53:'voimakasta tihkua',
    61:'heikkoa sadetta',
    62:'sadetta',
    63:'rankkasadetta',
    68:'räntää',
    69:'voimakasta räntää',
    71:'heikkoa lunta',
    72:'lumisadetta',
    73:'runsasta lunta',
    80:'ukkosta',
    95:'ukkoskuuroja',
    96:'ukkosta ja rakeita',
    97:'voimakasta ukkosta'
  };
  return m[Number(code)] || '';
}

/* Fallback-kuvaus sademäärästä, jos symboli puuttuu/tuntematon */
function fallbackFromRain(rain){
  const p = (rain == null ? 0 : Number(rain));
  if (p >= 7.0) return 'rankkasadetta';
  if (p >= 2.0) return 'sadetta';
  if (p >  0.1) return 'heikkoa sadetta';
  return '–'; // pouta → viiva (minimalistinen oletus)
}

/* Aikaväli: start = viimeisin mennyt tasatunti, end = seuraava klo 11:00 paikallista aikaa */
function computeLocalWindow(){
  const nowUTC = new Date();
  const nowLocal = new Date(nowUTC.toLocaleString('en-CA', { timeZone: TZ }));

  // start = floor to full hour (menneen tunnin alku)
  const startLocal = new Date(nowLocal);
  startLocal.setMinutes(0,0,0);

  // end = seuraava klo 11:00
  const endLocal = new Date(nowLocal);
  if (nowLocal.getHours() < 11) {
    endLocal.setHours(11,0,0,0); // tänään 11
  } else {
    endLocal.setDate(endLocal.getDate()+1);
    endLocal.setHours(11,0,0,0); // huomenna 11
  }
  return { startLocal, endLocal };
}

/* WFS-haku (väljä ikkuna: -3h → +24h), pyydetään myös SmartSymbol */
function buildUrl(lat, lon){
  const base = 'https://opendata.fmi.fi/wfs?service=WFS&version=2.0.0&request=getFeature';
  const sq   = 'fmi::forecast::harmonie::surface::point::timevaluepair';
  const params = 'temperature,precipitation1h,windspeedms,SmartSymbol,Weathersymbol3';
  const now = new Date();
  const startFetch = new Date(now); startFetch.setHours(startFetch.getHours()-3);
  const endFetch   = new Date(now); endFetch.setHours(endFetch.getHours()+24);
  const iso = d => d.toISOString().replace(/\.\d{3}Z$/,'Z');
  return `${base}&storedquery_id=${encodeURIComponent(sq)}&latlon=${encodeURIComponent(lat+','+lon)}&parameters=${encodeURIComponent(params)}&starttime=${encodeURIComponent(iso(startFetch))}&endtime=${encodeURIComponent(iso(endFetch))}&timestep=60`;
}

const parseXML = txt => {
  const x = new DOMParser().parseFromString(txt, 'application/xml');
  const ex = x.querySelector('Exception, ows\\:Exception');
  if (ex) {
    const t = x.querySelector('ExceptionText, ows\\:ExceptionText');
    throw new Error('FMI virhe: ' + (t ? t.textContent : 'Tuntematon virhe'));
  }
  return x;
};

const extract = x => {
  const get = (e,n)=>e.getElementsByTagNameNS('*',n)[0];
  const all = x.getElementsByTagNameNS('http://www.opengis.net/waterml/2.0','MeasurementTimeseries');
  const o = {};
  for (const s of all) {
    const id = (s.getAttribute('gml:id') || '').toLowerCase();
    let k = '';
    if      (id.includes('temperature'))      k = 'temperature';
    else if (id.includes('precipitation1h'))  k = 'precipitation1h';
    else if (id.includes('windspeedms'))      k = 'windspeedms';
    else if (id.includes('smartsymbol'))      k = 'SmartSymbol';
    else if (id.includes('weathersymbol3'))   k = 'Weathersymbol3';
    if (!k) continue;
    const map = new Map();
    for (const p of s.getElementsByTagNameNS('http://www.opengis.net/waterml/2.0','MeasurementTVP')){
      const t = get(p,'time')?.textContent;
      const v = get(p,'value')?.textContent;
      if (!t) continue;
      const num = v!=null ? Number(v) : null;
      map.set(t, isNaN(num) ? null : num);
    }
    o[k] = map;
  }
  return o;
};

function fetchWithTimeout(ms=9000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  return { signal: ctrl.signal, clear: ()=>clearTimeout(t) };
}

/* Apuri: ISO UTC -> paikallinen Date (TZ) */
function isoToLocalDate(iso){
  const d = new Date(iso); // UTC instant
  return new Date(d.toLocaleString('en-CA', { timeZone: TZ })); // seinäkello TZ:ssä
}

(async () => {
  // yritä tiputtaa osoitepalkki heti avauksessa
  scrollTo(0,1); setTimeout(()=>scrollTo(0,1), 150);

  if (!LAT || !LON) {
    out.innerHTML = `<div class="err">Puuttuvat koordinaatit. Käytä osoitetta muodossa:<br>
<code>?lat=60.1699&lon=24.9384</code></div>`;
    return;
  }

  try{
    const { startLocal, endLocal } = computeLocalWindow();

    const t = fetchWithTimeout(9000);
    const res = await fetch(buildUrl(LAT, LON), { cache:'no-store', signal: t.signal });
    t.clear();
    const txt = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}\n${txt.slice(0,200)}`);

    const ser = extract(parseXML(txt));

    // käytä lämpötilan aikaleimoja master-listana
    const keys = Array.from(ser.temperature?.keys?.() || []);
    keys.sort(); // ISOt nousevaan

    let html = '';
    let prevDesc = null;

    for (const iso of keys) {
      const local = isoToLocalDate(iso);
      if (local < startLocal || local > endLocal) continue;

      const temp = ser.temperature?.get(iso);
      const rain = ser.precipitation1h?.get(iso);
      const wind = ser.windspeedms?.get(iso);

      const ss   = ser.SmartSymbol?.get(iso);
      const ws3  = ser.Weathersymbol3?.get(iso);

      const rawSmart = symSmart(ss);
      const rawWS3   = symWS3(ws3);
      const descCore = rawSmart || rawWS3 || fallbackFromRain(rain);
      const desc     = descCore;

      const shownDesc = (desc === prevDesc && desc !== '–') ? '' : desc;
      prevDesc = desc;

      html += `<div class="row">
        <div>${fmtHM(local)}</div>
        <div>${temp!=null ? Math.round(temp) + '°C' : '–'}</div>
        <div>${shownDesc}</div>
        <div>${rain!=null ? rain.toFixed(1) + ' mm' : '–'}</div>
        <div>${wind!=null ? wind.toFixed(1) + ' m/s' : '–'}</div>
      </div>`;
    }

    out.innerHTML = html || `<div class="muted">Ei rivejä tälle ikkunalle.</div>`;
  } catch (e) {
    out.innerHTML = `<div class="err">${String(e.message || e)}</div>`;
  }
})();
</script>
