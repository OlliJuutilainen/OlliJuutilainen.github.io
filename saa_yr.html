<!doctype html>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex">
<title>SÄÄ SEURAAVAT 12 TUNTIA (FMI)</title>
<style>
  :root { color-scheme: dark; }
  html,body{height:100%}
  body{
    margin:0; padding:28px 14px 24px; background:#000; color:#e8e8e8;
    font:17px/1.5 Arial,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility
  }
  .list{ border-top:1px solid #2a2a2a; margin-top:6px; }
  .klohdr{
    color:#9aa; font-size:12px; letter-spacing:.3px; margin:6px 0 4px 0;
    display:grid; grid-template-columns:54px 64px 1fr 70px 64px;
  }
  .klohdr > div:first-child{ border-right:1px solid #2a2a2a; padding-right:10px; margin-right:4px; }
  .klohdr > div:not(:first-child){ visibility:hidden; }
  .row{
    display:grid; grid-template-columns:54px 64px 1fr 70px 64px;
    gap:8px; padding:6px 0; border-bottom:1px solid #1c1c1c;
  }
  .row > div:first-child{ border-right:1px solid #2a2a2a; padding-right:10px; margin-right:4px; }
  .muted{ color:#95a0aa } .err{ color:#ff6b6b; white-space:pre-wrap }
</style>

<div class="klohdr"><div>klo</div><div></div><div></div><div></div><div></div></div>
<div class="list" id="out" aria-live="polite"></div>

<script>
/* SmartSymbol ensisijainen (yö normalisoidaan), WS3 varmistus, sade-fallback.
   Näytä: viimeisin mennyt tasatunti + 12 seuraavaa tasatuntia (yht. 13 riviä).
   HH:MM, dedup-kuvaukset, tumma super-min. Koordinaatit URL:sta (?lat=...&lon=...). */

const q = new URLSearchParams(location.search);
const LAT = q.get('lat');
const LON = q.get('lon');
const TZ  = 'Europe/Helsinki';
const out = document.getElementById('out');

// Aika: pakota aina HH:MM kaksoispisteellä
const tFmt = new Intl.DateTimeFormat('fi-FI', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:TZ, hourCycle:'h23' });
function fmtHM_local(dLocal){
  const parts = tFmt.formatToParts(dLocal);
  const hh = parts.find(p=>p.type==='hour')?.value ?? '00';
  const mm = parts.find(p=>p.type==='minute')?.value ?? '00';
  return `${hh}:${mm}`;
}

// SmartSymbol → tiivis FI-teksti; yö (101..199) normalisoidaan %100
function symSmart(code){
  if (code == null) return '';
  const day = Number(code) % 100;
  if (day === 1) return 'selkeää';
  if (day === 2) return 'lähes selkeää';
  if (day === 3) return 'puolipilvistä';
  if (day === 4) return 'enimmäkseen pilvistä';
  if (day === 5 || day === 6) return 'pilvistä';
  if (day === 7) return 'pilvipeite vaihteleva';
  if (day === 8) return 'pilvipeite rikkoutuu';
  if (day === 9) return 'pilvipeite lisääntyy';
  if (day === 10 || day === 91) return 'utua';
  if (day === 11) return 'sumu hälvenemässä';
  if (day === 12 || day === 92) return 'sumua';
  if (day === 13) return 'sumua voimistuu';
  if (day >= 20 && day <= 29) return 'vaihtelevaa säätä';
  if (day === 30 || (day >= 31 && day <= 34)) return 'sumuista';
  if (day === 40) return 'sadetta';
  if (day === 41) return 'heikkoa tai kohtalaista sadetta';
  if (day === 42) return 'kovaa sadetta';
  if (day === 51) return 'heikkoa tihkua';
  if (day === 52) return 'tihkua';
  if (day === 53) return 'voimakasta tihkua';
  if (day === 54) return 'jäätävää heikkoa tihkua';
  if (day === 55) return 'jäätävää tihkua';
  if (day === 56) return 'jäätävää voimakasta tihkua';
  if (day === 57) return 'jäätävää tihkua';
  if (day === 60 || day === 61) return 'heikkoa vesisadetta';
  if (day === 62) return 'sadetta';
  if (day === 63) return 'rankkasadetta';
  if (day === 64) return 'jäätävää heikkoa vesisadetta';
  if (day === 65) return 'jäätävää vesisadetta';
  if (day === 66) return 'jäätävää kovaa vesisadetta';
  if (day === 67) return 'räntää (lumensekaista sadetta)';
  if (day === 68) return 'räntää';
  if (day === 69) return 'voimakasta räntää';
  if (day === 70 || day === 72) return 'lumisadetta';
  if (day === 71) return 'heikkoa lunta';
  if (day === 73) return 'runsasta lunta';
  if (day === 74) return 'heikkoa jääjyväsadetta';
  if (day === 75) return 'jääjyväsadetta';
  if (day === 76) return 'kovaa jääjyväsadetta';
  if (day === 77) return 'lumijyväsiä';
  if (day === 78) return 'jääkiteitä';
  if (day === 79) return 'jäätävää lumisadetta';
  if (day === 80 || day === 81) return 'heikkoja vesikuuroja';
  if (day === 82) return 'kuuroja';
  if (day === 83) return 'voimakkaita vesikuuroja';
  if (day === 84) return 'ankaria vesikuuroja';
  if (day === 85) return 'heikkoja lumikuuroja';
  if (day === 86) return 'lumikuuroja';
  if (day === 87) return 'voimakkaita lumikuuroja';
  if (day === 88) return 'räntäkuuroja';
  if (day === 89) return 'raekuuroja';
  if (day >= 93 && day <= 94) return 'poikkeuksellista säätä';
  if (day === 95) return 'ukkoskuuroja';
  if (day === 96) return 'ukkosta ja rakeita';
  if (day >= 97) return 'voimakasta ukkosta';
  if (day < 50) return 'pilvistä';
  if (day < 60) return 'tihkua';
  if (day < 70) return 'sadetta';
  if (day < 80) return 'lunta';
  if (day < 90) return 'kuuroja';
  return 'ukkosta';
}

// WS3 → tiivis FI-teksti (varmistus)
function symWS3(code){
  const m = {
    1:'selkeää', 2:'puolipilvistä', 3:'pilvistä',
    21:'sumua', 22:'utua',
    41:'heikkoja kuuroja', 42:'kuuroja', 43:'voimakkaita kuuroja',
    51:'heikkoa tihkua', 52:'tihkua', 53:'voimakasta tihkua',
    61:'heikkoa sadetta', 62:'sadetta', 63:'rankkasadetta',
    68:'räntää', 69:'voimakasta räntää',
    71:'heikkoa lunta', 72:'lumisadetta', 73:'runsasta lunta',
    80:'ukkosta', 95:'ukkoskuuroja', 96:'ukkosta ja rakeita', 97:'voimakasta ukkosta'
  };
  return m[Number(code)] || '';
}

// Fallback-kuvaus sademäärästä, jos symboli puuttuu/tuntematon
function fallbackFromRain(rain){
  const p = (rain == null ? 0 : Number(rain));
  if (p >= 7.0) return 'rankkasadetta';
  if (p >= 2.0) return 'sadetta';
  if (p >  0.1) return 'heikkoa sadetta';
  return '–';
}

// Aikaikkuna: viimeisin mennyt tasatunti + 12 seuraavaa tasatuntia (13 kpl)
function computeLocalHours(){
  // “seinäkello” TZ:ssä
  const nowLocal = new Date(new Date().toLocaleString('en-CA', { timeZone: TZ }));
  const start = new Date(nowLocal); start.setMinutes(0,0,0); // floor
  const hours = [];
  for (let i=0;i<=12;i++){
    const d = new Date(start);
    d.setHours(d.getHours()+i);
    hours.push(d); // paikallisaika
  }
  return hours;
}

// Rakenna FMI-haku (reilu marginaali kattamaan kaikki rivit)
function buildUrl(lat, lon){
  const base = 'https://opendata.fmi.fi/wfs?service=WFS&version=2.0.0&request=getFeature';
  const sq   = 'fmi::forecast::harmonie::surface::point::timevaluepair';
  const params = 'temperature,precipitation1h,windspeedms,SmartSymbol,Weathersymbol3';

  const hours = computeLocalHours();
  const startFetchLocal = new Date(hours[0]);   startFetchLocal.setHours(startFetchLocal.getHours()-1);
  const endFetchLocal   = new Date(hours.at(-1)); endFetchLocal.setHours(endFetchLocal.getHours()+2);

  const isoUTC = dLocal => new Date(Date.UTC(
    dLocal.getFullYear(), dLocal.getMonth(), dLocal.getDate(), dLocal.getHours(), 0, 0
  )).toISOString().replace(/\.\d{3}Z$/,'Z');

  const startISO = isoUTC(startFetchLocal);
  const endISO   = isoUTC(endFetchLocal);

  return `${base}&storedquery_id=${encodeURIComponent(sq)}&latlon=${encodeURIComponent(lat+','+lon)}&parameters=${encodeURIComponent(params)}&starttime=${encodeURIComponent(startISO)}&endtime=${encodeURIComponent(endISO)}&timestep=60`;
}

// XML → sarjat Mapiksi (key = ISO UTC string)
const parseXML = txt => {
  const x = new DOMParser().parseFromString(txt, 'application/xml');
  const ex = x.querySelector('Exception, ows\\:Exception');
  if (ex) {
    const t = x.querySelector('ExceptionText, ows\\:ExceptionText');
    throw new Error('FMI virhe: ' + (t ? t.textContent : 'Tuntematon virhe'));
  }
  return x;
};
const extract = x => {
  const get = (e,n)=>e.getElementsByTagNameNS('*',n)[0];
  const all = x.getElementsByTagNameNS('http://www.opengis.net/waterml/2.0','MeasurementTimeseries');
  const o = {};
  for (const s of all) {
    const id = (s.getAttribute('gml:id') || '').toLowerCase();
    let k = '';
    if      (id.includes('temperature'))      k = 'temperature';
    else if (id.includes('precipitation1h'))  k = 'precipitation1h';
    else if (id.includes('windspeedms'))      k = 'windspeedms';
    else if (id.includes('smartsymbol'))      k = 'SmartSymbol';
    else if (id.includes('weathersymbol3'))   k = 'Weathersymbol3';
    if (!k) continue;
    const map = new Map();
    for (const p of s.getElementsByTagNameNS('http://www.opengis.net/waterml/2.0','MeasurementTVP')){
      const t = get(p,'time')?.textContent;
      const v = get(p,'value')?.textContent;
      if (!t) continue;
      const num = v!=null ? Number(v) : null;
      map.set(t, isNaN(num) ? null : num);
    }
    o[k] = map;
  }
  return o;
};

function fetchWithTimeout(ms=9000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  return { signal: ctrl.signal, clear: ()=>clearTimeout(t) };
}

(async () => {
  // tiputa osoitepalkki heti avauksessa
  scrollTo(0,1); setTimeout(()=>scrollTo(0,1), 150);

  if (!LAT || !LON) {
    out.innerHTML = `<div class="err">Puuttuvat koordinaatit. Käytä osoitetta:<br><code>?lat=60.1699&lon=24.9384</code></div>`;
    return;
  }

  try{
    const t = fetchWithTimeout(9000);
    const res = await fetch(buildUrl(LAT, LON), { cache:'no-store', signal: t.signal });
    t.clear();
    const txt = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}\n${txt.slice(0,200)}`);

    const ser = extract(parseXML(txt));

    const hoursLocal = computeLocalHours();
    const isoUTC = dLocal => new Date(Date.UTC(
      dLocal.getFullYear(), dLocal.getMonth(), dLocal.getDate(), dLocal.getHours(), 0, 0
    )).toISOString().replace(/\.\d{3}Z$/,'Z');

    let html = '';
    let prevDesc = null;

    for (const dLocal of hoursLocal) {
      const key = isoUTC(dLocal); // haetaan tällä kaikista sarjoista
      const temp = ser.temperature?.get(key);
      const rain = ser.precipitation1h?.get(key);
      const wind = ser.windspeedms?.get(key);
      const ss   = ser.SmartSymbol?.get(key);
      const ws3  = ser.Weathersymbol3?.get(key);

      const rawSmart = symSmart(ss);
      const rawWS3   = symWS3(ws3);
      const descCore = rawSmart || rawWS3 || fallbackFromRain(rain);
      const desc     = descCore;

      const shownDesc = (desc === prevDesc && desc !== '–') ? '' : desc;
      prevDesc = desc;

      html += `<div class="row">
        <div>${fmtHM_local(dLocal)}</div>
        <div>${temp!=null ? Math.round(temp) + '°C' : '–'}</div>
        <div>${shownDesc}</div>
        <div>${rain!=null ? rain.toFixed(1) + ' mm' : '–'}</div>
        <div>${wind!=null ? wind.toFixed(1) + ' m/s' : '–'}</div>
      </div>`;
    }

    out.innerHTML = html || `<div class="muted">Ei rivejä tälle ikkunalle.</div>`;
  } catch (e) {
    out.innerHTML = `<div class="err">${String(e.message || e)}</div>`;
  }
})();
</script>
